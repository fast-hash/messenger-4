# Messenger-4 инфраструктурный аудит (2025-02-12)

## Резюме проблем

### 1. Репозиторий и Git hygiene

- `.gitignore` дублирует записи и не игнорирует `.env.*`, артефакты Vite/Playwright и pnpm-кэш.【F:.gitignore†L1-L26】
- `.gitattributes` отсутствует, поэтому нет единой политики EOL и защиты от случайного коммита бинарников.【dbe822†L1-L2】
- README даёт только краткий список команд без пошагового запуска сервера/клиента, нет требований к Node и .env настройкам.【F:README.md†L14-L26】
- В `client/README.md` остался шаблон Vite, не отражающий реальные шаги проекта.【F:client/README.md†L1-L13】

### 2. Пакеты и менеджер

- Репозиторий содержит `package-lock.json`, `pnpm-lock.yaml` и `pnpm-workspace.yaml`, фактически смешивая npm и pnpm и приводя к рассинхрону зависимостей.【F:package-lock.json†L1-L36】【F:pnpm-workspace.yaml†L1-L3】
- Минимальная версия Node не зафиксирована в `package.json`, хотя в скриптах используется `node --test` и Playwright.【F:package.json†L9-L27】
- Дублирование зависимостей: `jsonwebtoken` объявлен и в корне, и в `server/package.json`; `libsignal-protocol` подключён на сервере, но не используется в исходниках.【F:package.json†L31-L45】【F:server/package.json†L1-L28】
- `npm audit` не выполняется из-за отсутствия доступа к advisory API, но команда прописана в скриптах и CI-планах.【78af96†L1-L6】

### 3. Монорепо и скрипты

- Корневой `npm run build` падает, потому что у сервера нет `build` скрипта; `verify:server` вызывает несуществующий `npm -w server run lint`.【549fdb†L1-L9】【F:server/package.json†L1-L28】
- Husky pre-commit запускает `npm -w server test`, что ломает локальные коммиты из-за текущих провалов тестов MongoMemoryServer.【161f1f†L1-L17】【76c060†L1-L160】
- В корне нет унифицированных `pnpm -w` скриптов, запрошенных в требованиях.

### 4. Клиент (React/Vite)

- Vite-конфиг не подхватывает `Buffer`, `process` и WebCrypto-полифилы, хотя `libsignal` и keystore активно используют `Buffer`/`crypto`.【F:client/vite.config.js†L1-L121】【F:client/src/crypto/keystore.js†L1-L120】【F:client/src/crypto/signal.js†L1-L200】
- Нет `.env.example` для клиента, при этом `ChatPage` ожидает `VITE_API_URL` и даёт неочевидные ошибки без него.【F:client/src/pages/ChatPage.jsx†L82-L137】
- API-клиент использует `process.env.API_BASE_URL`, но это нигде не документировано, что мешает SSR/тестам.【F:client/src/api/request.js†L1-L44】

### 5. Сервер (Express)

- `MongoMemoryServer` пытается скачать MongoDB 7.0.24, которой нет в CDN, из-за чего валится 36 тестов и скрипты `verify:*`.【76c060†L1-L200】
- Нет проверки обязательных переменных окружения при старте, хотя код зависит от `JWT_SECRET`, `MONGO_URL`, `REDIS_URL` и др.【F:server/src/app.js†L40-L110】【F:server/src/middleware/auth.js†L25-L90】
- Отсутствует серверный ESLint и статический анализ, хотя корневой `lint` охватывает весь репозиторий и ломается на Node-specific правилах.

### 6. БД, кэш и миграции

- В проекте нет миграций/сидов вне тестового bootstrap; локальный dev требует ручного наполнения базы.【F:server/src/test/bootstrap.routes.js†L1-L55】
- Redis и Mongo конфигурация хранится только в `.env.example`, без docker healthcheck и без теста подключения в CI.【F:.env.example†L1-L6】【F:docker-compose.yml†L1-L23】

### 7. E2E-криптография

- Тест `test/crypto/test/crypto/double-ratchet.test.mjs` импортирует `../../client/test/libsignal-stub.mjs`, чего не существует, и падает по `ERR_MODULE_NOT_FOUND` во время `npm test`.【6da5b8†L1-L36】【c50369†L6-L22】
- Нет тестов на ситуацию «закончились одноразовые pre-key» и ротацию ключей на сервере (`keybundle` просто возвращает 410).【F:server/src/routes/keybundle.js†L1-L200】

### 8. Docker и локальный запуск

- `docker-compose.yml` поднимает только Mongo и Redis, без API/клиента и без healthcheck команд.【F:docker-compose.yml†L1-L23】
- Нет Makefile/PowerShell-скриптов для автоматизации `install/dev/build/up/down/logs`.

### 9. Качество кода и тесты

- `npm test` выдаёт 42/78 успешных тестов, остальные падают из-за MongoMemoryServer и неподключённого supertest клиента (из-за провалившегося setup).【76c060†L1-L200】
- Сервер не имеет ESLint-конфига, а корневой `eslint .` настраивается под браузерные правила клиента, что мешает строгим проверкам Node-кода.【F:client/eslint.config.js†L1-L30】

### 10. CI/CD

- В репозитории отсутствуют GitHub Actions/другие CI-конфиги; нет кэша node_modules, матрицы ОС, прогонов Docker compose и линтинга.
- Нет проверки на крупные файлы или сканирования секретов в пайплайне.

## Шаги воспроизведения

| Сценарий                               | Bash                                                  | PowerShell                                                |
| -------------------------------------- | ----------------------------------------------------- | --------------------------------------------------------- |
| Сборка монорепо падает                 | `npm run build`                                       | `npm run build`                                           |
| Юнит/интеграционные тесты валятся      | `npm test`                                            | `npm test`                                                |
| Audit не выполняется                   | `npm audit --omit=dev`                                | `npm audit --omit=dev`                                    |
| Husky блокирует коммиты                | `HUSKY=1 npm run prepare && npx husky run pre-commit` | `$env:HUSKY=1; npm run prepare; npx husky run pre-commit` |
| Запуск verify-набора ломается на Mongo | `npm run verify:server`                               | `npm run verify:server`                                   |

## Фиксы с кодом

### 1. Репозиторий/README

- Обновить `.gitignore`, добавить `.gitattributes`, расширить README.

```diff
+# .gitignore
+/.env*
+/.pnpm-store/
+/.turbo/
+*.lcov
+client/.env*
+client/dist/
+server/dist/
+client/playwright-report/
+client/test-results/
+coverage/
+pnpm-lock.yaml
```

```gitignore
# .gitattributes
* text=auto eol=lf
*.js linguist-language=JavaScript
*.ts linguist-language=TypeScript
*.{png,jpg,jpeg,gif,webp} binary
```

- README Quick Start (фрагмент):

````markdown
## Quick Start

```bash
nvm use 20
pnpm install
cp .env.example .env
cp client/.env.example client/.env.local
pnpm -w dev
```
````

```powershell
nvm use 20
pnpm install
Copy-Item .env.example .env
Copy-Item client/.env.example client/.env.local
pnpm -w dev
```

````

### 2. Менеджер пакетов и зависимости
- Перейти на pnpm: удалить `package-lock.json`, прописать `"packageManager": "pnpm@9"`, добавить `engines.node` и workspace-скрипты.
```diff
 "scripts": {
-  "build": "npm -w client run build && (npm -w server run build || echo 'server: build script not defined')",
+  "build": "pnpm -w build",
   "test": "node --test",
+  "dev": "pnpm -w dev",
+  "lint": "pnpm -w lint",
+  "format": "pnpm -w format",
+  "typecheck": "pnpm -w typecheck",
+  "install": "pnpm install"
 }
+"packageManager": "pnpm@9.12.0",
+"engines": { "node": ">=20.11" }
````

- Вынести `jsonwebtoken` из корневых deps, оставить в `server`; удалить неиспользуемый `libsignal-protocol` из `server/package.json` и добавить туда `lint`, `build` скрипты (например, `tsup`/`babel` или `node ./src/cli/build.js`).

### 3. Скрипты монорепо

- В корне `package.json` добавить workspace-алиасы:

```json
"pnpm": {
  "packageExtensions": {
    "libsignal-protocol": { "peerDependencies": { "buffer": "^6.0.3" } }
  }
},
"scripts": {
  "build": "pnpm -r --filter ./client --filter ./server run build",
  "dev": "pnpm -r --parallel --filter client --filter server run dev",
  "lint": "pnpm -r run lint",
  "test": "pnpm -r run test",
  "format": "pnpm -r run format"
}
```

- Настроить `server/package.json`:

```diff
 "scripts": {
-  "start": "node index.js",
-  "dev": "nodemon index.js",
-  "test": "node --test"
+  "start": "node dist/index.js",
+  "dev": "NODE_ENV=development nodemon index.js",
+  "build": "tsup src/app.js --format esm --dts false --out-dir dist",
+  "lint": "eslint . --ext js,mjs",
+  "test": "node --test"
 }
```

### 4. Клиентский build и polyfills

- Добавить `client/.env.example`:

```env
VITE_API_URL=http://localhost:3000
VITE_SOCKET_PATH=/socket.io
```

- В `client/src/main.jsx` подключить полифилы:

```diff
+import { Buffer } from 'buffer';
+import process from 'process';
+
+if (typeof window !== 'undefined') {
+  window.Buffer ??= Buffer;
+  window.process ??= process;
+}
```

- Обновить `client/vite.config.js`:

```diff
-import { defineConfig } from 'vite';
+import { defineConfig } from 'vite';
+import { nodePolyfills } from 'vite-plugin-node-polyfills';

 export default defineConfig({
-  plugins: [react()],
+  plugins: [
+    react(),
+    nodePolyfills({
+      globals: { Buffer: true, process: true },
+      modules: ['buffer', 'crypto'],
+    }),
+  ],
   resolve: {
     alias: {
       'libsignal-protocol': path.resolve(__dirname, 'src/crypto/libsignal-protocol/index.js'),
       '@': path.resolve(__dirname, 'src'),
-      'node:worker_threads': '/@empty-worker-threads',
+      'node:worker_threads': '/@empty-worker-threads',
+      buffer: 'buffer',
     },
   },
+  define: {
+    'process.env': {},
+    global: 'globalThis',
+  },
+  optimizeDeps: {
+    include: ['buffer'],
+  },
```

### 5. Сервер и тесты MongoMemoryServer

- Создать утилиту `server/test/helpers/memoryServer.js` с версией по умолчанию:

```js
import { MongoMemoryServer } from 'mongodb-memory-server';

export function createMongoMemoryServer() {
  return MongoMemoryServer.create({
    binary: {
      version: process.env.MONGOMS_VERSION || '7.0.14',
      downloadDir: '.mongodb-binaries',
    },
  });
}
```

- Во всех тестах заменить `MongoMemoryServer.create()` на `createMongoMemoryServer()`; аналогично в `scripts/verify-db.mjs`, `scripts/start-test-server.mjs`, `scripts/verify-ciphertext.mjs`.
- Добавить `pnpm test` пресет: `cross-env MONGOMS_VERSION=7.0.14 pnpm -r test`.
- Ввести в `server/src/index.js` валидацию env (например, библиотекой `zod`/`envalid`) и падать при `JWT_SECRET=change_me` в production.

### 6. Крипто-тесты

- Исправить относительный импорт:

```diff
-import { setupTestLibsignal } from '../../client/test/libsignal-stub.mjs';
+import { setupTestLibsignal } from '../../../../client/test/libsignal-stub.mjs';
```

- Добавить тесты на исчерпание pre-key:

```js
test('GET /api/keybundle/:userId -> 410 when pre-keys exhausted', async () => {
  // arrange
  // ... запрашиваем pre-key > max
  await assert.rejects(request.get(`/api/keybundle/${userId}`), /410/);
});
```

- Написать интеграционный сценарий регистрации → обмена ключами → отправки сообщения с повторной выдачей pre-keys.

### 7. Docker и скрипты

- Расширить `docker-compose.yml`:

```yaml
api:
  build: ./server
  env_file: ./.env
  depends_on:
    mongo:
      condition: service_healthy
    redis:
      condition: service_healthy
  ports:
    - '3000:3000'
  healthcheck:
    test: ['CMD', 'curl', '-f', 'http://localhost:3000/healthz']
web:
  build: ./client
  environment:
    VITE_API_URL: http://api:3000
  ports:
    - '5173:4173'
```

- Добавить `Makefile` и `scripts/dev.ps1`:

```make
install:
pnpm install

up:
docker compose up -d

dev:
pnpm -w dev
```

```powershell
param([ValidateSet('install','dev','build','up','down','logs')]$Command)
switch($Command){
  'install' { pnpm install }
  'dev' { pnpm -w dev }
  'up' { docker compose up -d }
  'down' { docker compose down }
  'logs' { docker compose logs -f }
}
```

### 8. Качество кода и CI

- Создать `eslint.config.js` в корне с отдельными конфигами для `client` (React) и `server` (Node). Настроить `eslint --max-warnings=0`.
- Настроить Vitest/Jest для критичных узлов (crypto, socket handshake) и добавить покрытие `c8` в CI.
- Добавить `.github/workflows/ci.yml`:

```yaml
name: CI
on: [push, pull_request]
jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        node: [20]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run lint
      - run: pnpm run build
      - run: pnpm run test
      - run: pnpm run verify:server
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: docker compose up -d
      - run: pnpm run verify:db
```

- Добавить шаг `gitleaks`/`trufflehog` и проверку файлов >100MB.

### Таблица переменных окружения

| Переменная                                              | Значение по умолчанию                  | Где используется                                                                                                           |
| ------------------------------------------------------- | -------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- |
| `PORT`                                                  | `3000`                                 | HTTP порт Express (`server/src/config.js`, `server/index.js`).【F:server/src/config.js†L1-L8】【F:server/index.js†L1-L19】 |
| `MONGO_URL`                                             | `mongodb://localhost:27017/messenger3` | Подключение Mongoose и verify-скрипты.【F:server/src/config.js†L1-L8】【F:server/src/app.js†L40-L63】                      |
| `REDIS_URL`                                             | `redis://localhost:6379`               | Replay Guard и Redis CLI.【F:server/src/config.js†L1-L8】【F:server/src/services/replayGuard.js†L28-L72】                  |
| `JWT_SECRET`/`JWT_SHARED_SECRET`                        | `change_me_to_a_long_random_string`    | Подпись токенов, socket auth, verify bootstrap.【F:server/src/config.js†L1-L8】【F:server/src/middleware/auth.js†L25-L90】 |
| `JWT_PUBLIC_KEY`                                        | —                                      | Проверка RS256 токенов (при наличии).【F:server/src/middleware/auth.js†L25-L90】                                           |
| `CORS_ORIGIN`                                           | `http://localhost:5173`                | CORS Express и Socket.IO.【F:server/src/config.js†L1-L8】【F:server/src/app.js†L96-L140】                                  |
| `SOCKET_ALLOWED_ORIGINS`                                | `CORS_ORIGIN`                          | Socket.IO CORS whitelist.【F:server/src/app.js†L232-L249】                                                                 |
| `JWT_AUDIENCE`/`JWT_ISSUER`                             | —                                      | Валидация JWT и Socket reauth.【F:server/src/app.js†L244-L280】【F:server/src/routes/auth.js†L1-L120】                     |
| `JSON_BODY_LIMIT`                                       | `256kb`                                | Ограничение JSON payload.【F:server/src/app.js†L104-L112】                                                                 |
| `RATE_LIMIT_WINDOW_MS`/`RATE_LIMIT_MAX`                 | `60000` / `120`                        | Пер-пользовательский лимитер сообщений.【F:server/src/app.js†L121-L139】                                                   |
| `MAX_CIPHERTEXT_B64`                                    | `131072`                               | Ограничение длины ciphertext.【F:server/src/routes/messages.js†L21-L70】                                                   |
| `REPLAY_TTL_SECONDS`                                    | `600`                                  | TTL replay guard.【F:server/src/routes/messages.js†L21-L70】                                                               |
| `KEYBUNDLE_MAX_PREKEYS`                                 | `200`                                  | Контроль upload pre-keys.【F:server/src/routes/keybundle.js†L81-L152】                                                     |
| `METRICS_TOKEN`/`PROMETHEUS_TOKEN`                      | —                                      | Защита `/metrics`.【F:server/src/app.js†L200-L220】                                                                        |
| `COOKIE_SECURE`                                         | `false` (dev)                          | Настройка cookie флага secure.【F:server/src/routes/auth.js†L21-L70】                                                      |
| `ACCESS_TOKEN_COOKIE_PATH`/`ACCESS_TOKEN_COOKIE_DOMAIN` | `/` / —                                | cookie параметры.【F:server/src/routes/auth.js†L30-L70】                                                                   |
| `VERIFY_MODE`                                           | `''`                                   | Включение тестовых bootstrap роутов.【F:server/src/test/bootstrap.routes.js†L1-L55】                                       |
| `API_BASE_URL`                                          | —                                      | SSR/Node fetch базовый URL для клиента.【F:client/src/api/request.js†L1-L44】                                              |
| `VITE_API_URL`                                          | —                                      | WebSocket и REST endpoint в браузере.【F:client/src/pages/ChatPage.jsx†L82-L137】                                          |

### Матрица портов

| Компонент                         | Порт  | Источник                                                                                         |
| --------------------------------- | ----- | ------------------------------------------------------------------------------------------------ |
| Express API                       | 3000  | `server/src/config.js` / `.env.example`.【F:server/src/config.js†L1-L8】【F:.env.example†L1-L6】 |
| Vite dev server                   | 5173  | `client/vite.config.js` server config.【F:client/vite.config.js†L17-L28】                        |
| MongoDB                           | 27017 | `docker-compose.yml`.【F:docker-compose.yml†L4-L13】                                             |
| Redis                             | 6379  | `docker-compose.yml`.【F:docker-compose.yml†L13-L21】                                            |
| Playwright preview (prod preview) | 4173  | Vite preview default (планируется прокидывать в docker).                                         |

## Чек-лист готовности

- [ ] Удалён `package-lock.json`, все пакеты устанавливаются `pnpm install --frozen-lockfile`.
- [ ] `pnpm -w build`, `pnpm -w test`, `pnpm -w lint`, `pnpm -w verify:server` выполняются на Windows и Linux.
- [ ] `MongoMemoryServer` скачивает фиксированную версию и кэширует бинарь локально.
- [ ] Все crypto/E2E тесты зелёные, включая сценарии с исчерпанием pre-keys.
- [ ] Docker compose поднимает mongo, redis, api, web с healthcheck, `make up` и `scripts/dev.ps1 -Command up` работают.
- [ ] CI workflow прогоняет lint/build/test на `ubuntu-latest` и `windows-latest`, кэширует pnpm store, запускает docker healthcheck и secret scan.
- [ ] README и `docs/` описывают пошаговый запуск «с нуля».

## Список PR’ов

1. **chore(repo):** обновить `.gitignore`, добавить `.gitattributes`, расширить README и client README, приложить .env шаблоны.
2. **build(dev):** миграция на pnpm, единые workspace-скрипты, `engines`, зачистка дублирующих зависимостей, `server` build/lint/typecheck.
3. **feat(client):** Vite polyfills, `client/.env.example`, обновлённые polyfills в `main.jsx`, ESLint/Prettier конфиг для клиента.
4. **feat(server):** env-валидация, фикс MongoMemoryServer helper, health-check `/healthz`, централизованный error handler и линтер.
5. **infra(docker):** расширенный docker-compose с api/web, Makefile + PowerShell скрипты, документация по запуску.
6. **test:** фиксы crypto-тестов (импорты), новые сценарии pre-key exhaustion, обновлённые unit/integration для keybundle/messages/socket.
7. **ci:** GitHub Actions (matrix + cache + docker job), артефакты билдов, secret scan, проверка крупных файлов.
8. **security:** `pnpm audit` (при доступе), `npm run secrets:scan` интегрирован в CI, рекомендации по управлению ключами и документирование zero-trust поведения.
